version: '3.8'

services:
  # 1. Redis Service (消息隊列)
  redis:
    image: redis:6.2-alpine
    container_name: redis_pubsub
    expose:
      - "6379"
    # 健康檢查確保其他服務等待 Redis 啟動
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 1s
      timeout: 3s
      retries: 5

  # 2. Python Processor Service (Redis Subscriber/Publisher)
  processor:
    build:
      context: .
      dockerfile: processor/Dockerfile.processor
    container_name: python_processor
    
    # 配置 GPU 支持
    gpus: all 

    depends_on:
      redis:
        condition: service_healthy
    
    environment:
      REDIS_HOST: redis 
      REDIS_PORT: 6379
      ASR_MODEL_NAME: medium
      
  # 3. Node.js Server Service (FFmpeg, Redis I/O, WebSocket)
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: node_websocket_server
    # 對外暴露 WebSocket 端口
    ports:
      - "8080:8080" 
    depends_on:
      redis:
        condition: service_healthy
    # 配置 Redis 連線信息 (使用服務名稱 'redis')
    environment:
      REDIS_HOST: redis 
      REDIS_PORT: 6379