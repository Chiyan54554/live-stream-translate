version: '3.8'

services:
  # 1. Redis Service (æ¶ˆæ¯éšŠåˆ—)
  redis:
    image: redis:6.2-alpine
    container_name: redis_pubsub
    expose:
      - "6379"
    # å¥åº·æª¢æŸ¥ç¢ºä¿å…¶ä»–æœå‹™ç­‰å¾… Redis å•Ÿå‹•
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 1s
      timeout: 3s
      retries: 5

  # 2. Python Processor Service (Redis Subscriber/Publisher)
  processor:
    build:
      context: .
      # ğŸŒŸ ä¿®æ­£è·¯å¾‘: å‡è¨­ Dockerfile.processor åœ¨æ ¹ç›®éŒ„
      dockerfile: processor/Dockerfile.processor
      # ğŸŒŸ é¸æ“‡ä¸€å€‹æ›´å¤§çš„æ¨¡å‹ï¼Œä»¥ä¾¿åœ¨ GPU ä¸Šç²å¾—æ›´å¥½çš„æ€§èƒ½
    container_name: python_processor
    
    # å•Ÿç”¨ GPU åŠ é€Ÿçš„é…ç½® (å¦‚æˆ‘å€‘ä¹‹å‰æ‰€è¨è«–)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all # ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„ GPU
              capabilities: [gpu]

    depends_on:
      redis:
        condition: service_healthy
    
    environment:
      REDIS_HOST: redis 
      REDIS_PORT: 6379
      ASR_MODEL_NAME: medium # å»ºè­°ä½¿ç”¨ 'medium' æ¨¡å‹ä»¥ç²å¾—æ›´å¥½çš„æº–ç¢ºåº¦
      
  # 3. Node.js Server Service (FFmpeg, Redis I/O, WebSocket)
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: node_websocket_server
    # å°å¤–æš´éœ² WebSocket ç«¯å£
    ports:
      - "8080:8080" 
    depends_on:
      redis:
        condition: service_healthy
    # é…ç½® Redis é€£ç·šä¿¡æ¯ (ä½¿ç”¨æœå‹™åç¨± 'redis')
    environment:
      REDIS_HOST: redis 
      REDIS_PORT: 6379