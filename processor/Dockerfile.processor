# Dockerfile for Python Processor (å»ºè­°ä½¿ç”¨ç¨ç«‹çš„ Dockerfile.processor)

# ğŸš€ ä½¿ç”¨ NVIDIA CUDA 12.8 åŸºç¤æ˜ åƒ (RTX 50 ç³»åˆ—æ”¯æ´)
FROM nvidia/cuda:12.8.0-cudnn-runtime-ubuntu22.04

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    HF_HOME=/root/.cache/huggingface \
    MODEL_CACHE_DIR=/root/.cache/huggingface/hub \
    PIP_CACHE_DIR=/root/.cache/pip \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    # ğŸš€ CUDA ç›¸é—œ
    CUDA_HOME=/usr/local/cuda \
    PATH=/usr/local/cuda/bin:$PATH \
    LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

# ğŸš€ å®‰è£ Python 3.11 å’Œå¿…è¦å¥—ä»¶
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 \
    python3.11-venv \
    python3-pip \
    libsndfile1 \
    ffmpeg \
    && ln -sf /usr/bin/python3.11 /usr/bin/python \
    && ln -sf /usr/bin/python3.11 /usr/bin/python3 \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* \
    && mkdir -p /root/.cache/huggingface/hub /root/.cache/pip

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½ requirementsï¼ˆåˆ†é›¢ä»¥åˆ©å¿«å–ï¼‰
COPY processor/requirements.txt .

# ğŸš€ å®‰è£ PyTorch 2.7 + CUDA 12.8 (æ”¯æ´ RTX 50 ç³»åˆ— sm_120)
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-compile torch==2.7.0 --index-url https://download.pytorch.org/whl/cu128 && \
    pip install --no-compile -r requirements.txt

# ğŸŒŸ å»ºç«‹ç¬¦è™Ÿé€£çµï¼Œè®“ CTranslate2 æ‰¾åˆ° cuDNN
RUN CUDNN_PATH=$(python -c "import nvidia.cudnn; print(nvidia.cudnn.__path__[0])")/lib && \
    mkdir -p /usr/local/lib/ctranslate2 && \
    ln -sf $CUDNN_PATH/libcudnn*.so* /usr/local/lib/ctranslate2/

# ğŸš€ åˆä½µ COPY æŒ‡ä»¤ï¼Œæ¸›å°‘å±¤æ•¸
COPY processor/__init__.py processor/config.py processor/text_utils.py \
     processor/translator.py processor/asr.py processor/main.py ./
COPY processor/mappings/ ./mappings/

# ğŸŒŸ å•Ÿå‹•æ™‚è¨­å®š LD_LIBRARY_PATHï¼Œè®“ CTranslate2 å„ªå…ˆä½¿ç”¨æˆ‘å€‘å®‰è£çš„ cuDNN
CMD ["sh", "-c", "export LD_LIBRARY_PATH=/usr/local/lib/ctranslate2:$(python -c 'import nvidia.cudnn; print(nvidia.cudnn.__path__[0])')/lib:$LD_LIBRARY_PATH && python -m main"]